<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Campus RideShare ‚Äî Role enforced onboarding + Post Ride</title>
    <style>
        :root {
            --accent: #3463ff;
            --accent2: #7c3aed;
            --muted: #6b7280;
            --bg: #f7f9fc;
            --surface: #fff;
            --danger: #ef4444;
            --text: #111827;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter, system-ui, Arial;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        .wrap {
            max-width: 1200px;
            margin: 24px auto;
            padding: 18px
        }

        .page {
            display: none
        }

        .page.active {
            display: block
        }

        /* cards */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 26px rgba(16, 24, 40, .06)
        }

        /* auth */
        .auth {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            align-items: center
        }

        .brand {
            color: #fff
        }

        .brand .logo {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background: rgba(255, 255, 255, .12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px
        }

        .auth-right {
            background: #fff;
            padding: 18px;
            border-radius: 12px
        }

        .input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e6e9ef;
            background: #fbfdff
        }

        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 700
        }

        .btn-primary {
            background: var(--text);
            color: #fff
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid #e6e9ef
        }

        /* onboarding */
        .progress {
            display: flex;
            gap: 8px;
            margin-bottom: 12px
        }

        .prog {
            flex: 1;
            height: 8px;
            border-radius: 8px;
            background: #eee
        }

        .prog.active {
            background: var(--accent)
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 12px
        }

        .role-card {
            padding: 14px;
            border-radius: 10px;
            border: 1px solid #eef2f6;
            background: #fff;
            cursor: pointer
        }

        .role-card.selected {
            border-color: var(--accent);
            box-shadow: 0 6px 18px rgba(52, 99, 255, .06);
            background: linear-gradient(180deg, rgba(52, 99, 255, .03), #fff)
        }

        /* app layout */
        .app {
            display: flex;
            gap: 18px
        }

        .sidebar {
            width: 220px
        }

        .nav-item {
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--muted);
            cursor: pointer
        }

        .nav-item.active {
            background: #f3f5ff;
            color: var(--accent)
        }

        .post-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            background: var(--text);
            color: #fff;
            border: none;
            font-weight: 800;
            cursor: pointer
        }

        .main {
            flex: 1
        }

        .search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px
        }

        .rides-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px
        }

        .ride-card {
            background: #fff;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #eef2f6
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .badge {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 8px;
            background: #f3f5ff;
            color: var(--accent);
            font-weight: 700
        }

        /* modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 20, .45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1300
        }

        .modal.active {
            display: flex
        }

        .modal-card {
            width: 95%;
            max-width: 680px;
            background: #fff;
            border-radius: 12px;
            padding: 18px
        }

        .form-row {
            margin-bottom: 10px
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700
        }

        .note {
            font-size: 13px;
            color: var(--muted)
        }

        @media(max-width:880px) {
            .auth {
                grid-template-columns: 1fr
            }

            .app {
                flex-direction: column
            }

            .sidebar {
                width: 100%
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- LOGIN PAGE -->
        <div id="loginPage" class="page active">
            <div class="card auth">
                <div class="brand"
                    style="padding:18px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2))">
                    <div class="logo">üéì</div>
                    <h1 style="margin-top:12px;color:white">Campus RideShare</h1>
                    <p style="color:rgba(255,255,255,.9)">Student mobility network ‚Äî college verified rides</p>
                </div>

                <div class="auth-right">
                    <h2 style="margin:0 0 8px 0">Welcome back</h2>
                    <p class="note" style="margin-bottom:12px">Sign in with your college email to continue. New? Click
                        Sign up.</p>

                    <div class="form-row">
                        <label class="form-label">College Email</label>
                        <input id="loginEmail" class="input" placeholder="student@college.edu" />
                    </div>

                    <div class="form-row">
                        <label class="form-label">Password</label>
                        <input id="loginPassword" type="password" class="input" placeholder="Enter password (demo)" />
                    </div>

                    <div style="display:flex;gap:8px;margin-top:6px">
                        <button class="btn btn-primary" onclick="doLogin()">Log In</button>
                        <button class="btn btn-ghost" onclick="startSignup()">Sign up</button>
                    </div>
                    <p class="note" style="margin-top:8px">This demo uses localStorage. On sign up we'll ask basic info
                        and role before showing the app.</p>
                </div>
            </div>
        </div>

        <!-- BASIC INFO (STEP 1) -->
        <div id="basicInfo" class="page">
            <div class="card" style="max-width:760px;margin:auto">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div>
                        <div style="font-weight:800">Basic Information</div>
                        <div class="small">Tell us a bit about yourself. Step 1 of 3</div>
                    </div>
                    <div class="small">Step 1 of 3</div>
                </div>

                <div class="form-row">
                    <label class="form-label">Full Name *</label>
                    <input id="fullName" class="input" placeholder="Enter your full name" />
                </div>

                <div class="form-row">
                    <label class="form-label">Phone Number *</label>
                    <input id="phone" class="input" placeholder="+91 98765 43210" />
                </div>

                <div class="form-row">
                    <label class="form-label">Bio (optional)</label>
                    <textarea id="bio" class="input" style="min-height:80px"
                        placeholder="Tell others about you..."></textarea>
                </div>

                <div style="display:flex;justify-content:space-between;margin-top:14px">
                    <button class="btn btn-ghost" onclick="cancelSignup()">Cancel</button>
                    <button class="btn btn-primary" onclick="goToRole()">Continue</button>
                </div>
            </div>
        </div>

        <!-- ROLE SELECTION (STEP 2) -->
        <div id="roleSelect" class="page">
            <div class="card" style="max-width:760px;margin:auto">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div>
                        <div style="font-weight:800">Choose Your Role</div>
                        <div class="small">How will you use Campus RideShare?</div>
                    </div>
                    <div class="small">Step 2 of 3</div>
                </div>

                <div class="progress" style="margin-bottom:18px">
                    <div class="prog active"></div>
                    <div class="prog active"></div>
                    <div class="prog"></div>
                </div>

                <div class="role-grid">
                    <div id="roleRider" class="role-card selected" data-role="rider" onclick="pickRole('rider')">
                        <div style="font-weight:800">Rider</div>
                        <div class="small">I'm looking for rides to get around campus and nearby areas</div>
                    </div>

                    <div id="roleDriver" class="role-card" data-role="driver" onclick="pickRole('driver')">
                        <div style="font-weight:800">Driver</div>
                        <div class="small">I have a car and want to offer rides to fellow students</div>
                    </div>

                    <div id="roleBoth" class="role-card" data-role="both" onclick="pickRole('both')">
                        <div style="font-weight:800">Both</div>
                        <div class="small">I'll both offer and look for rides depending on the situation</div>
                    </div>
                </div>

                <div style="display:flex;justify-content:space-between;margin-top:18px">
                    <button class="btn btn-ghost" onclick="backToBasic()">Back</button>
                    <div>
                        <button class="btn btn-ghost" onclick="skipOnboard()">Skip</button>
                        <button class="btn btn-primary" onclick="completeOnboard()">Continue</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPLETE (STEP 3) - confirmation -->
        <div id="complete" class="page">
            <div class="card" style="max-width:720px;margin:auto;text-align:center">
                <h2 style="margin-bottom:6px">You're all set</h2>
                <p class="small" style="margin-bottom:12px">We'll sign you in and take you to the app. You can edit
                    profile later.</p>
                <button class="btn btn-primary" onclick="enterApp()">Go to app</button>
            </div>
        </div>

        <!-- APP -->
        <div id="app" class="page">
            <div class="app" style="gap:18px">
                <div class="sidebar card">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                        <div class="avatar" id="sbAvatar">G</div>
                        <div>
                            <div id="sbName" style="font-weight:800">Guest</div>
                            <div id="sbRole" class="small">Not signed in</div>
                        </div>
                    </div>

                    <div style="display:flex;flex-direction:column;gap:8px">
                        <div class="nav-item active" id="navDiscover" onclick="showPane('discover')">üè† Discover Rides
                        </div>
                        <div class="nav-item" id="navMessages" onclick="showPane('messages')">üí¨ Messages <span
                                id="msgBadge"
                                style="margin-left:auto;background:#ff4d6d;color:white;padding:2px 8px;border-radius:12px;font-size:12px">2</span>
                        </div>
                        <div class="nav-item" id="navProfile" onclick="showPane('profile')">üë§ My Profile</div>
                    </div>

                    <div style="margin-top:12px">
                        <button id="postRideBtn" class="post-btn" onclick="openPostModal()">‚ûï Post Ride</button>
                        <button class="btn btn-ghost" style="width:100%;margin-top:8px"
                            onclick="openFilter()">Filters</button>
                        <button class="btn btn-ghost" style="width:100%;margin-top:8px;color:var(--danger)"
                            onclick="logout()">Logout</button>
                    </div>
                </div>

                <div class="main">
                    <!-- Discover pane -->
                    <div id="pane-discover" class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <div>
                                <div style="font-weight:800">Discover Rides</div>
                                <div class="small">Find your next ride</div>
                            </div>
                            <div><button class="btn btn-ghost" onclick="toggleListMap()">List / Map</button></div>
                        </div>

                        <div class="search-row">
                            <input id="sFrom" class="input" placeholder="From (e.g., Main Campus)" />
                            <input id="sTo" class="input" placeholder="To (e.g., Downtown)" />
                            <input id="sDate" class="input" type="date" style="max-width:170px" />
                            <button class="btn btn-primary" onclick="applySearch()">Search</button>
                        </div>

                        <div id="ridesCount" style="margin-bottom:8px">Available rides</div>
                        <div class="rides-grid" id="ridesGrid"></div>
                    </div>

                    <!-- Messages pane -->
                    <div id="pane-messages" class="card" style="display:none">
                        <div style="font-weight:800;margin-bottom:8px">Messages</div>
                        <div style="display:flex;gap:12px">
                            <div style="width:260px" id="convCol"></div>
                            <div style="flex:1" id="chatCol">Select a conversation</div>
                        </div>
                    </div>

                    <!-- Profile pane -->
                    <div id="pane-profile" class="card" style="display:none">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="display:flex;gap:12px;align-items:center">
                                <div class="avatar" id="profileAv">G</div>
                                <div>
                                    <div id="profileName" style="font-weight:800">Guest</div>
                                    <div id="profileEmail" class="small">-</div>
                                    <div id="profileRoleText" class="small">Role: -</div>
                                </div>
                            </div>
                            <div><button class="btn btn-ghost" onclick="editProfile()">Edit Profile</button></div>
                        </div>

                        <div style="margin-top:12px">
                            <div style="display:flex;gap:12px">
                                <div
                                    style="flex:1;background:#fff;border-radius:8px;padding:14px;border:1px solid #eef2f6">
                                    <div class="small">Total Rides</div>
                                    <div style="font-weight:800" id="statRides">0</div>
                                </div>
                                <div
                                    style="flex:1;background:#fff;border-radius:8px;padding:14px;border:1px solid #eef2f6">
                                    <div class="small">Rating</div>
                                    <div style="font-weight:800">4.8</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Post Ride modal (3 steps) -->
    <div id="postModal" class="modal">
        <div class="modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <h3 style="margin:0">Post a Ride</h3>
                    <div class="small">Share your ride with fellow students. Fill in details below.</div>
                </div>
                <div><button onclick="closeModal('postModal')">‚úï</button></div>
            </div>

            <div style="margin-top:12px">
                <div class="progress" style="margin-bottom:12px">
                    <div id="p1" class="prog active"></div>
                    <div id="p2" class="prog"></div>
                    <div id="p3" class="prog"></div>
                </div>

                <!-- Step 1: where -->
                <div id="postStep1">
                    <div class="form-row"><label class="form-label">Pickup Location *</label><input id="pmPickup"
                            class="input" placeholder="e.g., Main Campus, Library" /></div>
                    <div class="form-row"><label class="form-label">Drop-off Location *</label><input id="pmDropoff"
                            class="input" placeholder="e.g., Downtown, Airport" /></div>
                    <div class="form-row"><label class="form-label">Route Details (Optional)</label><input id="pmRoute"
                            class="input" placeholder="e.g., Via Highway 101" /></div>
                    <div style="display:flex;justify-content:space-between;margin-top:10px">
                        <button class="btn btn-ghost" onclick="closeModal('postModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="postNext(2)">Next</button>
                    </div>
                </div>

                <!-- Step 2: when & cost -->
                <div id="postStep2" style="display:none">
                    <div class="form-row"><label class="form-label">Date *</label><input id="pmDate" type="date"
                            class="input" /></div>
                    <div class="form-row"><label class="form-label">Departure Time *</label><input id="pmTime"
                            type="time" class="input" /></div>
                    <div class="form-row" style="display:flex;gap:8px">
                        <div style="flex:1"><label class="form-label">Available Seats</label><input id="pmSeats"
                                type="number" min="1" value="4" class="input" /></div>
                        <div style="flex:1"><label class="form-label">Cost per Person (‚Çπ)</label><input id="pmPrice"
                                type="number" min="0" value="0" class="input" /></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:10px">
                        <button class="btn btn-ghost" onclick="postNext(1)">Back</button>
                        <button class="btn btn-primary" onclick="postNext(3)">Next</button>
                    </div>
                </div>

                <!-- Step 3: preferences & notes -->
                <div id="postStep3" style="display:none">
                    <div class="form-row"><label class="form-label">Who can see this ride?</label>
                        <select id="pmVisibility" class="input">
                            <option value="college">College Community Only</option>
                            <option value="public">Public</option>
                            <option value="friends">Friends Only</option>
                        </select>
                    </div>

                    <div class="form-row"><label class="form-label">Additional Notes (optional)</label><textarea
                            id="pmNotes" class="input" placeholder="No smoking, luggage preference, etc."
                            style="min-height:80px"></textarea></div>

                    <div style="background:#f5f8ff;padding:12px;border-radius:8px" class="small">
                        <div style="font-weight:700;margin-bottom:6px">Before you post:</div>
                        <ul style="margin:0 0 0 16px;padding:0">
                            <li>Ensure your vehicle is in good condition</li>
                            <li>Confirm you have valid insurance and license</li>
                            <li>Be punctual and communicate changes</li>
                            <li>Review rider requests promptly</li>
                        </ul>
                    </div>

                    <div style="display:flex;justify-content:space-between;margin-top:12px">
                        <button class="btn btn-ghost" onclick="postNext(2)">Back</button>
                        <button class="btn btn-primary" onclick="submitRide()">Post Ride</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:0">Ride Details</h3>
                <div><button onclick="closeModal('detailsModal')">‚úï</button></div>
            </div>

            <div id="detailsBody" style="margin-top:12px"></div>
            <div id="detailsActions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"></div>
        </div>
    </div>

    <!-- Filter modal -->
    <div id="filterModal" class="modal">
        <div class="modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3>Filter Rides</h3><button onclick="closeModal('filterModal')">‚úï</button>
            </div>
            <div style="margin-top:12px">
                <div class="form-row"><label class="form-label">Max Price (‚Çπ)</label><input id="fltMax" type="number"
                        class="input" /></div>
                <div class="form-row"><label class="form-label">Min Rating</label><input id="fltMinR" type="number"
                        min="0" max="5" step="0.1" class="input" /></div>
                <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn btn-ghost"
                        onclick="clearFilters()">Reset</button><button class="btn btn-primary"
                        onclick="applyFilter()">Apply</button></div>
            </div>
        </div>
    </div>

    <script>
        /* ---------- state ---------- */
        let user = JSON.parse(localStorage.getItem('cr_user') || 'null');
        let rides = JSON.parse(localStorage.getItem('cr_rides') || 'null') || seedRides();
        let convos = JSON.parse(localStorage.getItem('cr_convos') || 'null') || seedConvos();
        let currentPostStep = 1;
        let editingRideId = null;

        /* ---------- helpers ---------- */
        function uid() { return Date.now() + Math.floor(Math.random() * 999); }
        function saveUser() { localStorage.setItem('cr_user', JSON.stringify(user)); }
        function saveRides() { localStorage.setItem('cr_rides', JSON.stringify(rides)); }
        function saveConvos() { localStorage.setItem('cr_convos', JSON.stringify(convos)); }
        function seedRides() {
            const d = (n) => { const dt = new Date(); dt.setDate(dt.getDate() + n); return dt.toISOString().slice(0, 10); };
            return [
                { id: 1, driver: 'Sarah Johnson', vehicle: 'Honda Civic', rating: 4.8, pickup: 'Main Campus', dropoff: 'Downtown', date: d(1), time: '09:00', seats: 2, price: 50, badge: 'Campus', notes: 'No heavy luggage', visibility: 'college' },
                { id: 2, driver: 'Michael Chen', vehicle: 'Toyota Camry', rating: 4.9, pickup: 'North Dorms', dropoff: 'Airport', date: d(1), time: '14:00', seats: 1, price: 150, badge: 'Public', notes: 'Space for 1 suitcase', visibility: 'public' },
                { id: 3, driver: 'Emily Rodriguez', vehicle: 'Tesla Model 3', rating: 5.0, pickup: 'Library', dropoff: 'Shopping Mall', date: d(1), time: '18:30', seats: 3, price: 30, badge: 'Campus', notes: 'Quiet rider preferred', visibility: 'college' }
            ];
        }
        function seedConvos() {
            return [
                { id: 1, with: 'Sarah Johnson', avatar: 'S', last: "I'll be leaving at 9 AM sharp.", messages: [{ from: 'Sarah Johnson', text: "I'll be leaving at 9 AM sharp.", time: '10:30 AM' }] },
                { id: 2, with: 'Michael Chen', avatar: 'M', last: 'Airport ride confirmed.', messages: [{ from: 'Michael Chen', text: 'Airport ride confirmed. I have space.', time: '11:00 AM' }] }
            ];
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        /* ---------- auth & onboarding ---------- */
        function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert('Enter college email'); return; }
            // demo: create simple user with unknown role -> force onboarding
            user = { id: 'user-' + uid(), email, name: email.split('@')[0], phone: '', bio: '', role: null, avatar: (email[0] || 'G').toUpperCase() };
            saveUser();
            // go to basic info first
            // auto-fill basic form if any
            document.getElementById('fullName').value = user.name;
            showPage('basicInfo');
        }

        function startSignup() {
            // show basic info
            user = user || { id: 'user-' + uid(), email: '', name: '', role: null, avatar: 'G' };
            document.getElementById('fullName').value = user.name || '';
            showPage('basicInfo');
        }

        function cancelSignup() { // return to login
            user = null; localStorage.removeItem('cr_user'); showPage('loginPage');
        }

        function goToRole() {
            const name = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            if (!name || !phone) { alert('Please enter name and phone'); return; }
            user = user || {};
            user.name = name; user.phone = phone; user.bio = document.getElementById('bio').value.trim(); user.avatar = (name[0] || 'G').toUpperCase();
            saveUser();
            showPage('roleSelect');
            // default selection
            pickRole('rider');
        }

        function pickRole(role) {
            user = user || {};
            user.role = role;
            saveUser();
            // update UI selection classes
            ['roleRider', 'roleDriver', 'roleBoth'].forEach(id => document.getElementById(id).classList.remove('selected'));
            if (role === 'rider') document.getElementById('roleRider').classList.add('selected');
            if (role === 'driver') document.getElementById('roleDriver').classList.add('selected');
            if (role === 'both') document.getElementById('roleBoth').classList.add('selected');
        }

        function completeOnboard() {
            if (!user || !user.role) { alert('Please choose a role'); return; }
            saveUser();
            showPage('complete');
        }

        function skipOnboard() {
            user = user || { id: 'user-' + uid(), name: 'Guest', role: 'rider', avatar: 'G' };
            saveUser();
            enterApp();
        }

        function enterApp() {
            saveUser();
            // ensure role set
            if (!user || !user.role) { alert('Please pick a role first'); showPage('roleSelect'); return; }
            initApp();
            showPage('app');
        }

        /* ---------- app init & UI ---------- */
        function initApp() {
            // sidebar
            document.getElementById('sbName').textContent = (user && user.name) || 'Guest';
            document.getElementById('sbRole').textContent = 'Role: ' + ((user && user.role) || 'rider');
            document.getElementById('sbAvatar').textContent = (user && user.avatar) || 'G';
            document.getElementById('profileAv').textContent = (user && user.avatar) || 'G';
            document.getElementById('profileName').textContent = (user && user.name) || 'Guest';
            document.getElementById('profileEmail').textContent = (user && user.email) || '';

            // show/hide post ride button if driver or both
            if (user.role === 'driver' || user.role === 'both') document.getElementById('postRideBtn').style.display = 'block';
            else document.getElementById('postRideBtn').style.display = 'none';

            renderRides();
            renderConvos();
            renderProfileStats();
            showPane('discover');
        }

        function logout() { if (!confirm('Logout?')) return; user = null; localStorage.removeItem('cr_user'); showPage('loginPage'); }

        /* ---------- render rides & details ---------- */
        function renderRides(list = rides) {
            const cont = document.getElementById('ridesGrid');
            if (!list || !list.length) { cont.innerHTML = '<div class="small">No rides found</div>'; document.getElementById('ridesCount').textContent = 'Available rides - 0'; return; }
            document.getElementById('ridesCount').textContent = `Available rides - ${list.length} found`;
            cont.innerHTML = list.map(r => `
    <div class="ride-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="avatar">${r.driver[0]}</div>
          <div>
            <div style="font-weight:800">${escapeHtml(r.driver)} <span class="small">${r.vehicle ? '‚Ä¢ ' + escapeHtml(r.vehicle) : ''}</span></div>
            <div class="small">‚≠ê ${r.rating} ¬∑ <span class="badge">${r.visibility === 'college' ? 'Campus' : (r.visibility === 'public' ? 'Public' : 'Friends')}</span></div>
          </div>
        </div>
      </div>
      <div style="margin-top:8px">
        <div style="font-weight:700">${escapeHtml(r.pickup)}</div>
        <div class="small">‚Üì</div>
        <div style="font-weight:700">${escapeHtml(r.dropoff)}</div>
        <div class="small" style="margin-top:8px">üìÖ ${r.date} ¬∑ üïí ${r.time}</div>
        <div class="small" style="margin-top:8px">üë• ${r.seats} seats ¬∑ ‚Çπ ${r.price}</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="small">Posted by ${escapeHtml(r.driver)}</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="viewDetails(${r.id})">View Details</button>
          ${(user && (user.role === 'rider' || user.role === 'both')) ? `<button class="btn btn-primary" onclick="requestSeat(${r.id})">Request</button>` : ''}
        </div>
      </div>
    </div>
  `).join('');
        }

        function viewDetails(id) {
            const r = rides.find(x => x.id === id);
            if (!r) { alert('Not found'); return; }
            const body = document.getElementById('detailsBody');
            body.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div class="avatar">${r.driver[0]}</div>
      <div>
        <div style="font-weight:800">${escapeHtml(r.driver)} <span class="small">${escapeHtml(r.vehicle || '')}</span></div>
        <div class="small">Rating: ${r.rating}</div>
      </div>
    </div>
    <hr style="margin:12px 0;border:none;border-top:1px solid #f2f4f7"/>
    <div style="font-weight:700">Route</div>
    <div class="small">${escapeHtml(r.pickup)} ‚Üí ${escapeHtml(r.dropoff)}</div>
    <div style="margin-top:8px" class="small">Route details: ${escapeHtml(r.route || '‚Äî')}</div>
    <div style="margin-top:8px" class="small">Date: ${r.date} ¬∑ Time: ${r.time}</div>
    <div style="margin-top:8px" class="small">Seats: ${r.seats} ¬∑ Price: ‚Çπ${r.price}</div>
    <div style="margin-top:8px"><div style="font-weight:700">Notes</div><div class="small">${escapeHtml(r.notes || '‚Äî')}</div></div>
    <div style="margin-top:8px"><div style="font-weight:700">Visibility</div><div class="small">${r.visibility}</div></div>
  `;
            const actions = document.getElementById('detailsActions');
            actions.innerHTML = '';
            if (user && (user.role === 'rider' || user.role === 'both')) {
                actions.innerHTML = `<button class="btn btn-primary" onclick="requestSeat(${r.id}); closeModal('detailsModal')">Request Seat</button>`;
            } else if (user && (user.role === 'driver' || user.role === 'both') && user.name === r.driver) {
                actions.innerHTML = `<button class="btn btn-ghost" onclick="editRide(${r.id}); closeModal('detailsModal')">Edit Ride</button>`;
            } else {
                actions.innerHTML = `<button class="btn btn-ghost" onclick="closeModal('detailsModal')">Close</button>`;
            }
            openModal('detailsModal');
        }

        function requestSeat(id) {
            if (!user) { alert('Sign in first'); return; }
            const r = rides.find(x => x.id === id);
            if (!r) return alert('Ride not found');
            if (r.seats <= 0) return alert('No seats available');
            r.seats -= 1; saveRides(); renderRides();
            alert('Seat requested ‚Äî driver will be notified in messages (demo).');
            // add to convos
            let conv = convos.find(c => c.with === r.driver);
            if (!conv) { conv = { id: uid(), with: r.driver, avatar: r.driver[0], last: `Seat request from ${user.name}`, messages: [] }; convos.unshift(conv); }
            conv.messages.push({ from: user.name, text: `Requesting seat for ${r.date} at ${r.time}`, time: new Date().toLocaleTimeString() });
            conv.last = `Seat request from ${user.name}`;
            saveConvos();
            renderConvosList();
        }

        /* ---------- post ride flow ---------- */
        function openPostModal() {
            if (!user) return alert('Sign in first');
            if (!(user.role === 'driver' || user.role === 'both')) return alert('Only drivers can post rides. Change role in profile.');
            // reset
            editingRideId = null;
            currentPostStep = 1; updatePostUI();
            document.getElementById('pmPickup').value = ''; document.getElementById('pmDropoff').value = ''; document.getElementById('pmRoute').value = '';
            document.getElementById('pmDate').value = ''; document.getElementById('pmTime').value = ''; document.getElementById('pmSeats').value = '4';
            document.getElementById('pmPrice').value = '0'; document.getElementById('pmNotes').value = ''; document.getElementById('pmVisibility').value = 'college';
            openModal('postModal');
        }
        function updatePostUI() {
            document.getElementById('p1').classList.toggle('active', currentPostStep >= 1);
            document.getElementById('p2').classList.toggle('active', currentPostStep >= 2);
            document.getElementById('p3').classList.toggle('active', currentPostStep >= 3);
            document.getElementById('postStep1').style.display = currentPostStep === 1 ? 'block' : 'none';
            document.getElementById('postStep2').style.display = currentPostStep === 2 ? 'block' : 'none';
            document.getElementById('postStep3').style.display = currentPostStep === 3 ? 'block' : 'none';
        }
        function postNext(step) {
            // basic validation for step transitions
            if (step === 2) {
                const pu = document.getElementById('pmPickup').value.trim();
                const doff = document.getElementById('pmDropoff').value.trim();
                if (!pu || !doff) { alert('Please fill pickup and dropoff'); return; }
            }
            if (step === 3) {
                const date = document.getElementById('pmDate').value;
                const time = document.getElementById('pmTime').value;
                if (!date || !time) { alert('Please select date and time'); return; }
            }
            currentPostStep = step; updatePostUI();
        }
        function submitRide() {
            // final validation
            const pickup = document.getElementById('pmPickup').value.trim();
            const dropoff = document.getElementById('pmDropoff').value.trim();
            const route = document.getElementById('pmRoute').value.trim();
            const date = document.getElementById('pmDate').value;
            const time = document.getElementById('pmTime').value;
            const seats = parseInt(document.getElementById('pmSeats').value || '1', 10);
            const price = parseFloat(document.getElementById('pmPrice').value || '0');
            const notes = document.getElementById('pmNotes').value.trim();
            const visibility = document.getElementById('pmVisibility').value;
            if (!pickup || !dropoff || !date || !time) { alert('Please fill required fields'); return; }

            if (editingRideId) {
                // update
                const idx = rides.findIndex(r => r.id === editingRideId);
                if (idx !== -1) {
                    rides[idx] = { ...rides[idx], pickup, dropoff, route, date, time, seats, price, notes, visibility };
                    saveRides(); renderRides(); closeModal('postModal'); alert('Ride updated');
                    editingRideId = null; return;
                }
            }

            const newR = { id: uid(), driver: user.name, vehicle: '', rating: 5.0, pickup, dropoff, route, date, time, seats, price, notes, visibility };
            rides.unshift(newR); saveRides(); renderRides(); closeModal('postModal'); alert('Ride posted');
        }

        /* edit ride */
        function editRide(id) {
            const r = rides.find(x => x.id === id); if (!r) return alert('Ride not found');
            if (!(user.role === 'driver' || user.role === 'both') || user.name !== r.driver) { alert('You can only edit your own rides'); return; }
            editingRideId = id;
            // prefill modal
            document.getElementById('pmPickup').value = r.pickup;
            document.getElementById('pmDropoff').value = r.dropoff;
            document.getElementById('pmRoute').value = r.route || '';
            document.getElementById('pmDate').value = r.date;
            document.getElementById('pmTime').value = r.time;
            document.getElementById('pmSeats').value = r.seats;
            document.getElementById('pmPrice').value = r.price;
            document.getElementById('pmNotes').value = r.notes || '';
            document.getElementById('pmVisibility').value = r.visibility || 'college';
            currentPostStep = 1; updatePostUI(); openModal('postModal');
        }

        /* ---------- filters & search ---------- */
        function applySearch() {
            const f = document.getElementById('sFrom').value.trim().toLowerCase();
            const t = document.getElementById('sTo').value.trim().toLowerCase();
            const d = document.getElementById('sDate').value;
            let list = rides.slice();
            if (f) list = list.filter(r => r.pickup.toLowerCase().includes(f));
            if (t) list = list.filter(r => r.dropoff.toLowerCase().includes(t));
            if (d) list = list.filter(r => r.date === d);
            renderRides(list);
        }
        function openFilter() { openModal('filterModal'); }
        function applyFilter() {
            const max = parseFloat(document.getElementById('fltMax').value || '0');
            const minR = parseFloat(document.getElementById('fltMinR').value || '0');
            let list = rides.slice();
            if (max) list = list.filter(r => r.price <= max);
            if (minR) list = list.filter(r => r.rating >= minR);
            renderRides(list); closeModal('filterModal');
        }
        function clearFilters() { document.getElementById('fltMax').value = ''; document.getElementById('fltMinR').value = ''; }

        /* ---------- messages ---------- */
        function renderConvos() {
            renderConvosList();
            // first conv content if any
            if (convos.length) openConv(convos[0].id);
        }
        function renderConvosList() {
            const col = document.getElementById('convCol');
            col.innerHTML = convos.map(c => `<div style="padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px;cursor:pointer" onclick="openConv(${c.id})"><div style="display:flex;gap:8px;align-items:center"><div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;display:flex;align-items:center;justify-content:center">${c.avatar}</div><div><div style="font-weight:700">${c.with}</div><div class="small">${c.last}</div></div></div></div>`).join('');
        }
        function openConv(id) {
            const conv = convos.find(c => c.id === id);
            if (!conv) return;
            const pane = document.getElementById('chatCol');
            pane.innerHTML = `<div style="font-weight:800">${conv.with}</div>` + conv.messages.map(m => `<div style="background:#f6f8fb;padding:8px;border-radius:8px;margin-top:8px"><strong>${m.from}:</strong><div>${m.text}</div><div class="small" style="opacity:.8">${m.time}</div></div>`).join('');
        }

        /* ---------- profile ---------- */
        function renderProfileStats() {
            document.getElementById('statRides').textContent = rides.filter(r => r.driver === (user && user.name)).length;
        }
        function editProfile() {
            const newName = prompt('Full name', user.name || '');
            if (newName) user.name = newName;
            const role = prompt('Role (rider/driver/both)', user.role || 'rider');
            if (role) user.role = role;
            saveUser(); initApp();
        }

        /* ---------- navigation ---------- */
        function showPane(name) {
            document.querySelectorAll('#pane-discover,#pane-messages,#pane-profile').forEach(e => e.style.display = 'none');
            document.getElementById('pane-' + name).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (name === 'discover') document.getElementById('navDiscover').classList.add('active');
            if (name === 'messages') document.getElementById('navMessages').classList.add('active');
            if (name === 'profile') document.getElementById('navProfile').classList.add('active');
        }

        /* ---------- misc ---------- */
        function toggleListMap() { alert('Map placeholder ‚Äî integrate map provider later.'); }
        function escapeHtml(t) { if (!t) return ''; return String(t).replace(/[&<>"'`]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[s]); }

        /* ---------- boot ---------- */
        (function boot() {
            if (user && user.role) { initApp(); showPage('app'); } else if (user) { // partial user -> ask onboarding
                document.getElementById('fullName').value = user.name || '';
                showPage('basicInfo');
            } else { showPage('loginPage'); }
        })();

    </script>
</body>

</html>